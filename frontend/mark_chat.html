<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>MARK.IA Chat</title>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
    }

    /* üîπ D√° um pequeno respiro no topo s√≥ no mobile,
       pra n√£o cortar o avatar nem o nome "Mark.IA" */
    @media (max-width: 768px) {
      body {
        padding-top: 10px !important;
      }
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 16px;
      background: #f4f5fb;
    }

    :root { --vh: 1vh; }

    .chat-container {
      width: 100%;
      max-width: 100%;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.12);
      display: flex;
      flex-direction: column;
      height: calc(var(--vh) * 100 - 32px); /* 100% da √°rea √∫til - padding do body */
      overflow: hidden;
    }

    .chat-header {
      display: flex;
      align-items: center;
      padding: 16px 20px;
      background: linear-gradient(90deg, #2563eb, #38bdf8);
      color: white;
    }

    .chat-header-avatar {
      width: 48px;
      height: 48px;
      border-radius: 999px;
      overflow: hidden;
      margin-right: 12px;
      background: rgba(255, 255, 255, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chat-header-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .chat-header-text h1 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
    }

    .chat-header-text p {
      margin: 2px 0 0 0;
      font-size: 13px;
      opacity: 0.9;
    }

    .chat-messages {
      flex: 1;
      padding: 16px 18px;
      overflow-y: auto;
      background: linear-gradient(180deg, #f5f7ff, #eef2ff);
    }

    .msg-row {
      display: flex;
      margin-bottom: 10px;
    }

    .msg-row.user {
      justify-content: flex-end;
    }

    .msg-row.mark {
      justify-content: flex-start;
    }

    .msg-bubble {
      max-width: 80%;
      padding: 10px 14px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.4;
      white-space: pre-wrap;
    }

    .msg-row.user .msg-bubble {
      background: #2563eb;
      color: white;
      border-bottom-right-radius: 4px;
    }

    .msg-row.mark .msg-bubble {
      background: white;
      color: #0f172a;
      border-bottom-left-radius: 4px;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.08);
    }

    .typing-indicator {
      font-size: 12px;
      color: #64748b;
      padding: 0 18px 8px;
    }

    .input-area {
      padding: 10px 12px;
      border-top: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
      gap: 8px;
      background: #f9fafb;
    }

    .input-area textarea {
      flex: 1;
      resize: none;
      border-radius: 999px;
      border: 1px solid #cbd5f5;
      padding: 10px 14px;
      font-size: 14px;
      outline: none;
      min-height: 40px;
      max-height: 120px;
    }

    .input-area textarea:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.3);
    }

    .send-button {
      border-radius: 999px;
      border: none;
      background: #2563eb;
      color: white;
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }

    .send-button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .icon-button {
      border-radius: 999px;
      border: 1px solid #cbd5f5;
      background: #ffffff;
      width: 36px;
      height: 36px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
    }
    /* üéôÔ∏è Efeito quando o microfone est√° gravando */
    .icon-button.gravando {
      background: #dc2626;
      border-color: #b91c1c;
      color: #ffffff;
      animation: mic-pulse 1s infinite;
      transform: scale(1.05);
    }

    /* Anima√ß√£o de "pulsar" ao redor do bot√£o */
    @keyframes mic-pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(220, 38, 38, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(220, 38, 38, 0);
      }
    }


    .icon-button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    @media (max-width: 768px) {
      body {
        padding: 8px;
      }
      .chat-container {
        height: calc(var(--vh) * 100 - 16px);
        border-radius: 0; /* se quiser ele encostado nas laterais no mobile */
      }
      .msg-bubble {
        max-width: 85%;
      }
    }
  </style>

  <script>
    // üîπ Corrige altura 100% em celulares (iOS / Android)
    function updateVh() {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    window.addEventListener('load', updateVh);
    window.addEventListener('resize', updateVh);
    window.addEventListener('orientationchange', updateVh);
  </script>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <div class="chat-header-avatar">
        <!-- Trocar depois pelo avatar oficial do MARK -->
        <img src="https://via.placeholder.com/150x150.png?text=MARK" alt="MARK">
      </div>
      <div class="chat-header-text">
        <h1>Mark.IA</h1>
        <p>Fale com o maior especialista em branding e marketing.</p>
      </div>
    </div>

    <div id="chatMessages" class="chat-messages"></div>

    <div id="typing" class="typing-indicator" style="display: none;">
      MARK est√° digitando...
    </div>

    <div class="input-area">
      <button id="attachBtn" class="icon-button" title="Anexar arquivo">+</button>
      <textarea id="userInput" placeholder="Digite sua pergunta..."></textarea>
      <button id="micBtn" class="icon-button" title="Falar por voz">üé§</button>
      <button id="sendBtn" class="send-button">Enviar</button>

      <!-- input escondido para anexar arquivos (futuro) -->
      <input type="file" id="fileInput" multiple style="display:none" />
    </div>
  </div>

  <script>
    console.log("MARK chat carregado");

    // üëâ Detecta se est√° no local ou no servidor
    let API_URL;

    if (
      window.location.hostname === "localhost" ||
      window.location.hostname === "127.0.0.1"
    ) {
      // Ambiente local
      API_URL = "http://127.0.0.1:8000";
    } else {
      // Ambiente online ‚Äî Render (coloque seu dom√≠nio oficial aqui)
      API_URL = "https://mivmark-backend.onrender.com";
    }

    console.log("API usada pelo MARK:", API_URL);

    // ID do usu√°rio injetado pelo Streamlit
    const USUARIO_ID = "{{USUARIO_ID}}";

    const chatMessages = document.getElementById("chatMessages");
    const userInput    = document.getElementById("userInput");
    const sendBtn      = document.getElementById("sendBtn");
    const typing       = document.getElementById("typing");
    const attachBtn    = document.getElementById("attachBtn");
    const micBtn       = document.getElementById("micBtn");
    const fileInput    = document.getElementById("fileInput");

    function addMessage(text, from = "user") {
      const row = document.createElement("div");
      row.className = "msg-row " + (from === "user" ? "user" : "mark");

      const bubble = document.createElement("div");
      bubble.className = "msg-bubble";
      bubble.textContent = text;

      row.appendChild(bubble);
      chatMessages.appendChild(row);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    /**
     * Envia mensagem para o MARK.
     * @param {string|null} textoParam  Mensagem j√° pronta (usado na voz). Se null, l√™ do textarea.
     * @param {boolean} origemVoz       true se a pergunta veio do microfone.
     */
    async function enviarMensagem(textoParam = null, origemVoz = false) {
      // Se veio da voz, usamos o texto passado; se n√£o, pegamos do textarea
      const texto = textoParam !== null ? textoParam.trim() : userInput.value.trim();
      if (!texto) return;

      addMessage(texto, "user");

      // S√≥ limpa o campo se a origem for texto digitado (pra manter coer√™ncia visual se quiser)
      if (!origemVoz) {
        userInput.value = "";
      }
      userInput.focus();

      sendBtn.disabled = true;
      typing.style.display = "block";

      let resposta = "";

      try {
        // tenta converter o USUARIO_ID para n√∫mero (se n√£o der, manda null)
        let uid = parseInt(USUARIO_ID, 10);
        if (Number.isNaN(uid)) {
          uid = null;
        }

        const resp = await fetch(`${API_URL}/mark/stream`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            mensagem: texto,
            usuario_id: uid
          })
        });

        if (!resp.ok || !resp.body) {
          throw new Error("Falha na requisi√ß√£o ao MARK");
        }

        const reader = resp.body.getReader();
        const decoder = new TextDecoder("utf-8");

        // Cria o bal√£o vazio do MARK para ir preenchendo em streaming
        const row = document.createElement("div");
        row.className = "msg-row mark";
        const bubble = document.createElement("div");
        bubble.className = "msg-bubble";
        bubble.textContent = "";
        row.appendChild(bubble);
        chatMessages.appendChild(row);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          const chunk = decoder.decode(value, { stream: true });
          resposta += chunk;
          bubble.textContent = resposta;
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // üîä Fala em voz alta a resposta completa (Text-To-Speech)
        // ‚úÖ Agora S√ì quando a origem for voz
        if (origemVoz && "speechSynthesis" in window && resposta) {
          const utterance = new SpeechSynthesisUtterance(resposta);
          utterance.lang = "pt-BR";
          utterance.rate = 2;
          utterance.pitch = 0.9;
          window.speechSynthesis.cancel();
          window.speechSynthesis.speak(utterance);
        }
      } catch (e) {
        console.error(e);
        addMessage("Erro ao falar com o MARK. Verifique se o backend est√° rodando.", "mark");
      } finally {
        sendBtn.disabled = false;
        typing.style.display = "none";
      }
    }

    // Bot√£o enviar (texto ‚Üí s√≥ texto)
    sendBtn.addEventListener("click", () => enviarMensagem(null, false));

    // Enter envia / Shift+Enter quebra linha (texto ‚Üí s√≥ texto)
    userInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        enviarMensagem(null, false);
      }
    });

    // Bot√£o de anexo ‚Äì abre o seletor
    attachBtn.addEventListener("click", () => {
      fileInput.click();
    });

    fileInput.addEventListener("change", () => {
      if (fileInput.files.length > 0) {
        addMessage(
          `üìé ${fileInput.files.length} arquivo(s) selecionado(s) (envio ainda em desenvolvimento).`,
          "mark"
        );
      }
    });

    // üéôÔ∏è Reconhecimento de voz (fala -> texto)
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = null;

    if (SpeechRecognition) {
      recognition = new SpeechRecognition();
      recognition.lang = "pt-BR";
      recognition.continuous = false;
      recognition.interimResults = false;
    } else {
      console.warn("Reconhecimento de voz n√£o suportado neste navegador.");
    }

    micBtn.addEventListener("click", () => {
      if (!recognition) {
        alert("Seu navegador n√£o suporta reconhecimento de voz. Tente usar o Chrome ou Edge.");
        return;
      }

      micBtn.disabled = true;
      micBtn.classList.add("gravando");

      recognition.start();
    });

    if (recognition) {
      recognition.addEventListener("result", (event) => {
        const texto = event.results[0][0].transcript;

        // Se quiser mostrar o texto no campo tamb√©m:
        userInput.value = texto;

        // üöÄ Envia como ORIGEM VOZ (ativa TTS)
        enviarMensagem(texto, true);
      });

      recognition.addEventListener("error", (event) => {
        console.error("Erro no reconhecimento de voz:", event.error);
      });

      recognition.addEventListener("end", () => {
        micBtn.disabled = false;
        micBtn.classList.remove("gravando");
      });
    }
  </script>
</body>
</html>
